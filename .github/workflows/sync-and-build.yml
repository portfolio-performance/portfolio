name: Weekly Multi-Branch Sync

on:
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at midnight
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      did_sync: ${{ steps.sync.outputs.synced }}
      new_release: ${{ steps.check_release.outputs.new_release }}
      release_tag: ${{ steps.check_release.outputs.release_tag }}
      release_name: ${{ steps.check_release.outputs.release_name }}
      release_body: ${{ steps.check_release.outputs.release_body }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          fetch-depth: 0

      - name: Check for new upstream release
        id: check_release
        run: |
          # Get the latest release from upstream
          response=$(curl -s https://api.github.com/repos/portfolio-performance/portfolio/releases/latest)
          
          # Check if API call was successful
          if [ -z "$response" ] || echo "$response" | grep -q '"message".*"Not Found"'; then
            echo "Failed to fetch release information from upstream"
            echo "new_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          latest_release=$(echo "$response" | jq -r '.tag_name')
          release_name=$(echo "$response" | jq -r '.name')
          release_body=$(echo "$response" | jq -r '.body')
          
          echo "Latest upstream release: $latest_release"
          
          # Check if this release already exists in our repo
          git fetch origin --tags
          if git rev-parse "refs/tags/$latest_release" >/dev/null 2>&1; then
            echo "Release $latest_release already exists in our repo"
            echo "new_release=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected: $latest_release"
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "release_tag=$latest_release" >> $GITHUB_OUTPUT
            echo "release_name=$release_name" >> $GITHUB_OUTPUT
            # Escape the release body for multiline output
            {
              echo "release_body<<EOF"
              echo "$release_body"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Sync Logic
        id: sync
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/portfolio-performance/portfolio.git
          git fetch upstream
          
          # Update master
          git checkout master
          git merge upstream/master --no-edit
          git push origin master
          
          # Update your feature branch
          git checkout TLVTrade2
          git merge master --no-edit
          git push origin TLVTrade2
          echo "synced=true" >> $GITHUB_OUTPUT

  create-release:
    needs: sync
    if: needs.sync.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout TLVTrade2 branch
        uses: actions/checkout@v4
        with:
          ref: TLVTrade2
          token: ${{ secrets.SYNC_TOKEN }}
          fetch-depth: 0

      - name: Create Release on TLVTrade2
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_TOKEN }}
          RELEASE_TAG: ${{ needs.sync.outputs.release_tag }}
          RELEASE_NAME: ${{ needs.sync.outputs.release_name }}
          RELEASE_BODY: ${{ needs.sync.outputs.release_body }}
        run: |
          # Create a tag on TLVTrade2 branch
          git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG for TLVTrade2"
          git push origin "$RELEASE_TAG"
          
          # Create release notes file
          cat > release_notes.md << 'EOFNOTES'
          ${{ needs.sync.outputs.release_body }}
          
          ---
          
          This release is based on upstream portfolio-performance/portfolio ${{ needs.sync.outputs.release_tag }}, synced to TLVTrade2 branch.
          EOFNOTES
          
          # Create the release using GitHub CLI
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_NAME (TLVTrade2)" \
            --notes-file release_notes.md \
            --target TLVTrade2

  # CALL THE BUILD WORKFLOW
  call-build:
    needs: [sync, create-release]
    if: always() && needs.sync.outputs.did_sync == 'true' && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped')
    # Points to the file in your repo: .github/workflows/build-tlv.yml
    uses: arnonm/portfolio/.github/workflows/build-tlv.yml@TLVTrade2
    secrets: inherit # Passes secrets (like SYNC_TOKEN) to the build workflow
